---
title: "使用 Django debug toolbar 分析 ORM Query（含 Ajax）"
date: 2018-04-27
layout: post
categories: Django
published: true
comments: true
---

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">使用 Django debug toolbar 分析 ORM Query（含 Ajax）</h2>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">背景</h2>
<div class="outline-text-2" id="text-2">
<p>
环境：
</p>

<ol class="org-ol">
<li>Django 1.11.9
</li>
<li>Python 2.7.13
</li>
<li>djangorestframework 3.7.7
</li>
<li>MySQL 5.7.17
</li>
</ol>

<p>
信条:
</p>

<blockquote>
<p>
过早优化是万恶之源
</p>
</blockquote>

<p>
原由：
</p>

<p>
使用 Django 这么久，慢慢形成了一个习惯，写 Model 的时候会考虑业务的查询条件，给相应的字段做索引，写 ORM query 的时候会考虑到这个 query 在编译成 SQL 语句时会产生几次查询或者 Join 情况是怎样的，这些是自己的经验和直觉，要验证是否正确就需要使用 <a href="https://github.com/jazzband/django-debug-toolbar">django-debug-toolbar</a> 了。
</p>

<p>
<!-- more -->
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">安装</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">Part 1 普通安装</h3>
<div class="outline-text-3" id="text-3-1">
<p>
根据 django-debug-toolbar 的 <a href="https://django-debug-toolbar.readthedocs.io/en/stable/installation.html">官方文档</a> 进行安装：
</p>

<p>
使用 <code>pip install django-debug-toolbar</code> 安装好库。
</p>

<p>
<code>settings.py</code> 配置如下:
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ff0000;"># </span><span style="color: #ff0000;">INSATALLED_APP</span>
<span style="color: #ffff00;">INSTALLED_APPS</span> = [
    <span style="color: #ff0000;"># </span><span style="color: #ff0000;">...</span>
    <span style="color: #00ff00;">'django.contrib.staticfiles'</span>, <span style="color: #ff0000;"># </span><span style="color: #ff0000;">&#36825;&#20010;&#24517;&#39035;&#35201;&#26377;</span>
    <span style="color: #ff0000;"># </span><span style="color: #ff0000;">...</span>
    <span style="color: #00ff00;">'debug_toolbar'</span>,
]

<span style="color: #ff0000;"># </span><span style="color: #ff0000;">MIDDLEWARE</span>
<span style="color: #ffff00;">MIDDLEWARE</span> = [
    <span style="color: #ff0000;"># </span><span style="color: #ff0000;">...</span>
    <span style="color: #00ff00;">'debug_toolbar.middleware.DebugToolbarMiddleware'</span>,
    <span style="color: #ff0000;"># </span><span style="color: #ff0000;">...</span>
]

<span style="color: #ff0000;"># </span><span style="color: #ff0000;">&#28155;&#21152; INTERNAL_IPS</span>
<span style="color: #ffff00;">INTERNAL_IPS</span> = (<span style="color: #00ff00;">'127.0.0.1'</span>,)

<span style="color: #ff0000;"># </span><span style="color: #ff0000;">&#37197;&#32622; JQuery &#21644; SHOW_TOOLBAR_CALLBACK</span>
<span style="color: #ffff00;">DEBUG_TOOLBAR_CONFIG</span> = {
    <span style="color: #00ff00;">'JQUERY_URL'</span>: <span style="color: #00ff00;">'http://code.jquery.com/jquery-2.1.1.min.js'</span>,
    <span style="color: #00ff00;">'SHOW_TOOLBAR_CALLBACK'</span>: <span style="color: #00ffff; font-weight: bold;">lambda</span> request: DEBUG,
}
</pre>
</div>

<p>
注意：
</p>
<ol class="org-ol">
<li><code>JQuery</code> 的 cdn 地址要换成国内可以访问的，否则界面会被卡住。
</li>
<li><code>SHOW_TOOLBAR_CALLBACK</code> 如果不配置界面展示不出来。
</li>
</ol>

<p>
<code>urls.py</code> 配置如下:
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #00ffff; font-weight: bold;">from</span> django.conf <span style="color: #00ffff; font-weight: bold;">import</span> settings
<span style="color: #00ffff; font-weight: bold;">from</span> django.conf.urls <span style="color: #00ffff; font-weight: bold;">import</span> include, url

<span style="color: #00ffff; font-weight: bold;">if</span> settings.DEBUG:
    <span style="color: #00ffff; font-weight: bold;">import</span> debug_toolbar
    <span style="color: #ffff00;">urlpatterns</span> = [
        url(r<span style="color: #00ff00;">'^__debug__/'</span>, include(debug_toolbar.urls)),
    ] + urlpatterns
</pre>
</div>

<p>
刷新页面后应该可以看到如下界面：
</p>


<div class="figure">
<p><img src="http://cdn.defcoding.com/B25491EA-7867-41DC-93A1-805A0CA17341.png" alt="B25491EA-7867-41DC-93A1-805A0CA17341.png" />
</p>
</div>

<p>
点击展开全部选项：
</p>


<div class="figure">
<p><img src="http://cdn.defcoding.com/5C91644A-0A76-46D0-8D28-6407C0FB763D.png" alt="5C91644A-0A76-46D0-8D28-6407C0FB763D.png" />
</p>
</div>

<p>
点击 SQL 选项可以看到当前 URL 使用的 SQL 语句：
</p>


<div class="figure">
<p><img src="http://cdn.defcoding.com/C8902D70-FB0F-44DE-B2E6-377D2FB51868.png" alt="C8902D70-FB0F-44DE-B2E6-377D2FB51868.png" />
</p>
</div>

<p>
至此，已经可以使用这个工具去做验证了。
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">Part 2 添加 Ajax 查询支持</h3>
<div class="outline-text-3" id="text-3-2">
<p>
由于使用 django-rest-framework，数据都是通过接口返回的，要分析接口的 query 还需要安装一个额外的工具：<a href="https://github.com/recamshak/django-debug-panel">django-debug-panel</a> 。
</p>

<p>
根据 <a href="https://github.com/recamshak/django-debug-panel">django-debug-panel 文档</a>，步骤如下：
</p>

<p>
使用 <code>pip install django-debug-panel</code>
</p>

<p>
<code>settings.py</code> 配置如下：
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffff00;">INSTALLED_APPS</span> = [
    <span style="color: #ff0000;"># </span><span style="color: #ff0000;">...</span>
    <span style="color: #00ff00;">'django.contrib.staticfiles'</span>, <span style="color: #ff0000;"># </span><span style="color: #ff0000;">&#36825;&#20010;&#24517;&#39035;&#35201;&#26377;</span>
    <span style="color: #ff0000;"># </span><span style="color: #ff0000;">...</span>
    <span style="color: #00ff00;">'debug_toolbar'</span>,
    <span style="color: #00ff00;">'debug_panel'</span>,
]

<span style="color: #ff0000;"># </span><span style="color: #ff0000;">MIDDLEWARE</span>
<span style="color: #ffff00;">MIDDLEWARE</span> = [
    <span style="color: #ff0000;"># </span><span style="color: #ff0000;">...</span>
    <span style="color: #00ff00;">'debug_panel.middleware.DebugPanelMiddleware'</span>,
    <span style="color: #ff0000;"># </span><span style="color: #ff0000;">...</span>
]

<span style="color: #ff0000;"># </span><span style="color: #ff0000;">&#28155;&#21152; INTERNAL_IPS</span>
<span style="color: #ffff00;">INTERNAL_IPS</span> = (<span style="color: #00ff00;">'127.0.0.1'</span>,)

<span style="color: #ff0000;"># </span><span style="color: #ff0000;">&#37197;&#32622; JQuery &#21644; SHOW_TOOLBAR_CALLBACK</span>
<span style="color: #ffff00;">DEBUG_TOOLBAR_CONFIG</span> = {
    <span style="color: #00ff00;">'JQUERY_URL'</span>: <span style="color: #00ff00;">'http://code.jquery.com/jquery-2.1.1.min.js'</span>,
    <span style="color: #00ff00;">'SHOW_TOOLBAR_CALLBACK'</span>: <span style="color: #00ffff; font-weight: bold;">lambda</span> request: DEBUG,
}
</pre>
</div>

<p>
Chrome 安装 <a href="https://chrome.google.com/webstore/detail/django-debug-panel/nbiajhhibgfgkjegbnflpdccejocmbbn">Django Debug Panel</a> 插件。
</p>

<p>
安装配置好效果如下：
</p>


<div class="figure">
<p><img src="http://cdn.defcoding.com/0E5A627F-9A89-4598-86B9-C7AB2FB83AB0.png" alt="0E5A627F-9A89-4598-86B9-C7AB2FB83AB0.png" />
</p>
</div>


<div class="figure">
<p><img src="http://cdn.defcoding.com/DB36FC06-69F2-4322-B5A2-7186FDA77C38.png" alt="DB36FC06-69F2-4322-B5A2-7186FDA77C38.png" />
</p>
</div>

<p>
这里介绍了工具的安装和基本使用，下来说说调优。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">调优相关</h2>
<div class="outline-text-2" id="text-4">
<p>
未完待续&#x2026;
</p>
</div>
</div>
