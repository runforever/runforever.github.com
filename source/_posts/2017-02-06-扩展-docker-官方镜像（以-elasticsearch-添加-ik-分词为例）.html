---
title: "扩展 Docker 官方镜像（以 Elasticsearch 添加 ik 分词为例）"
date: 2017-02-06
layout: post
categories: [Docker, Elasticsearch]
published: true
comments: true
---

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">需求</h2>
<div class="outline-text-2" id="text-1">
<p>
最近做的一个应用使用 Elasticsearch 做全文搜索引擎，由于是中文的全文搜索，需要 Elasticsearch 的中文分词插件对内容进行分词，经过调研决定使用 Elasticsearch 5.1.1 版本（现已更新成 5.2.0 版本）和 <a href="https://github.com/medcl/elasticsearch-analysis-ik">elasticsearch-analysis-ik</a> 中文分词插件。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">使用 Docker 搭建环境</h2>
<div class="outline-text-2" id="text-2">
<p>
我主要使用 Docker 来搭建一切开发环境，所以便想到了使用 Elastisearch 的官方 Docker 镜像扩展安装 ik 分词插件的方案。
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">方案一：使用 docker commit 的方式扩展</h2>
<div class="outline-text-2" id="text-3">
<p>
<b>先说结果，这种方式扩展官方镜像无法启动，具体原因不明，读者如果知道，请告诉我。</b>
</p>

<p>
之所以一开始使用这种方案是因为我自己 Django 开发环境的镜像都是这样扩展的，但是经过我的测试用这种方式扩展 PostgreSQL 和 Elasticsearch 的官方 Docker 镜像就会导致扩展后的镜像无法启动，虽然不能使用，我还是把这个方案的操作流程分享出来。
</p>

<p>
<!-- more -->
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">操作流程</h3>
<div class="outline-text-3" id="text-3-1">
<p>
下载 Elasticsearch 镜像
</p>
<div class="org-src-container">

<pre class="src src-bash">docker pull elasticsearch
</pre>
</div>

<p>
下载 ik 的分词
进入 ik 的 <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases">release</a> 下载页面，根据 Elasticsearch 的版本下载相应的编译好的 ik 分词插件，然后解压
</p>

<p>
进入镜像的 bash shell，新建 ik 分词插件文件夹
</p>
<div class="org-src-container">

<pre class="src src-bash">docker run -it elasticsearch:latest /bin/bash
mkdir -p /usr/share/elasticsearch/plugins/ik
</pre>
</div>

<p>
使用 docker copy 命令将下载并且解压好的 ik 分词拷贝到 docker container 里
</p>
<div class="org-src-container">

<pre class="src src-bash">docker copy elasticsearch-analysis-ik-5.2.0 es_container_id:/root
</pre>
</div>

<p>
使用打开的 bash shell container 将 /root 目录下的 ik 分词文件拷贝到 /usr/share/elasticsearch/plugins/ik 中
</p>
<div class="org-src-container">

<pre class="src src-bash">cd /root
cp -r elasticsearch-analysis-ik-5.2.0/* /usr/share/elasticsearch/plugins/ik
</pre>
</div>

<p>
退出 docker container 并且将修改提交
</p>
<div class="org-src-container">

<pre class="src src-bash">docker commit -a 'add ik plugin' -m 'runforever' es_container_id{768cadafcd9} es_ik:latest
</pre>
</div>

<p>
使用如下 docker-compose.yml 启动，启动命令 <code>docker-compose up</code>
</p>
<div class="org-src-container">

<pre class="src src-yaml"><span style="color: #ffff00;">version</span>: <span style="color: #00ff00;">'2'</span>
<span style="color: #ffff00;">services</span>:
  <span style="color: #ffff00;">es</span>:
    <span style="color: #ffff00;">build</span>: .
    <span style="color: #ffff00;">image</span>: es_ik:latest
    <span style="color: #ffff00;">environment</span>:
      - http.host=0.0.0.0
      - transport.host=127.0.0.1
</pre>
</div>

<p>
报错提示：
<img src="http://cdn.defcoding.com/9BDDB7EF-B72F-4252-97A5-048E4C4AD5E3.png" alt="9BDDB7EF-B72F-4252-97A5-048E4C4AD5E3.png" />
</p>

<p>
参考：ik <a href="https://github.com/medcl/elasticsearch-analysis-ik#install">安装文档 </a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">方案二：使用 Dockerfile 扩展</h2>
<div class="outline-text-2" id="text-4">
<p>
上面的方案不行就只有使用 Dockerfile 扩展方案了，这个方案只是把上面的操作写到 Dockerfile 里。
</p>
<div class="org-src-container">

<pre class="src src-bash">FROM elasticsearch:latest
RUN sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get install zip
RUN mkdir -p /usr/share/elasticsearch/plugins/ik
RUN cd /usr/share/elasticsearch/plugins/ik &amp;&amp; wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.1.1/elasticsearch-analysis-ik-5.1.1.zip &amp;&amp; unzip elasticsearch-analysis-ik-5.1.1.zip
</pre>
</div>

<p>
使用：
</p>
<div class="org-src-container">

<pre class="src src-bash">docker build . -t es_ik:latest
docker-compose up
</pre>
</div>

<p>
运行结果：
<img src="http://cdn.defcoding.com/1E49F66B-D801-437D-B138-21CA2370BDE9.png" alt="1E49F66B-D801-437D-B138-21CA2370BDE9.png" />
</p>

<p>
GitHub 地址：<a href="https://github.com/runforever/es_ik5.1.1">es_ik5.1.1</a>
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">总结</h2>
<div class="outline-text-2" id="text-5">
<p>
如果需要给官方 Docker 官方镜像添加功能，使用 Dockerfile 的方式就可以了。
</p>

<p>
小技巧一：使用 daocloud 可以加速下载 Docker Hub 镜像的速度，<a href="https://www.daocloud.io/mirror#accelerator-doc">使用教程</a>。<br  />
小技巧二：扩展镜像的时候把软件源换成国内的源，例如：<br  />
<code>RUN sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list</code>
</p>
</div>
</div>
